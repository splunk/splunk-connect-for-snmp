---
# Source: splunk-connect-for-snmp/templates/redis/redis-ha-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: release-name-redis-ha
  namespace: default
  labels:
    app: release-name-redis
    app.kubernetes.io/name: redis
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/component: database
spec:
  serviceName: release-name-redis-headless
  replicas: 3
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      app: release-name-redis
  template:
    metadata:
      labels:
        app: release-name-redis
      annotations:
        checksum/redis-config: 52233e7984ec9733ee5d72c255220b5f26923d0723b6a2dd9d645205d3bf81d5
        checksum/redis-secret: 908cbead70ef3a415f7509bf2922a7eb195dd8dc27ba5735ecde8c7794bb4b74
    spec:
      securityContext:
        runAsUser: 999
        fsGroup: 999
      initContainers:
      - name: fix-permissions
        image: redis:8.2.2
        imagePullPolicy: IfNotPresent
        command:
        - sh
        - -c
        - |
          echo "Fixing permissions on /data..."
          chown -R 999:999 /data
          chmod -R 755 /data
          ls -ln /data
        volumeMounts:
        - name: redis-data
          mountPath: /data
        securityContext:
          runAsUser: 0
      containers:
      - name: redis
        image: redis:8.2.2
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 6379
          name: redis
        env:
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: release-name-redis-secret
              key: password
        command:
        - sh
        - -c
        args:
        - |
          cp /etc/redis/redis.conf /tmp/redis.conf
          echo "requirepass $REDIS_PASSWORD" >> /tmp/redis.conf
          echo "masterauth $REDIS_PASSWORD" >> /tmp/redis.conf

          # Announce pod IP for Sentinel
          echo "replica-announce-ip $POD_IP" >> /tmp/redis.conf
          echo "replica-announce-port 6379" >> /tmp/redis.conf

          # Start Redis
          # Sentinel will handle promotion - all start as replicas initially
          HOSTNAME=$(hostname)
          MASTER_NAME="release-name-redis-ha-0"
          MASTER_HOST="$MASTER_NAME.release-name-redis-headless"

          if [ "$HOSTNAME" = "$MASTER_NAME" ]; then
            echo "Starting as master"
          else
            echo "replicaof $MASTER_HOST 6379" >> /tmp/redis.conf
            echo "Starting as replica of $MASTER_HOST"
          fi

          exec redis-server /tmp/redis.conf
        volumeMounts:
        - name: redis-data
          mountPath: /data
        - name: redis-config
          mountPath: /etc/redis
        resources:
          {}
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - |
              redis-cli -a "$REDIS_PASSWORD" ping
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - |
              redis-cli -a "$REDIS_PASSWORD" ping
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
      volumes:
      - name: redis-config
        configMap:
          name: release-name-redis-config
  volumeClaimTemplates:
  - metadata:
      name: redis-data
    spec:
      accessModes: 
        - ReadWriteOnce
      storageClassName: microk8s-hostpath
      resources:
        requests:
          storage: 5Gi
