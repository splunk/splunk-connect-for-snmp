---
# Source: splunk-connect-for-snmp/templates/ui/deployment-backend.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ui-backend-deployment
  labels:
    app: ui-backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ui-backend
  template:
    metadata:
      labels:
        app: ui-backend
      annotations:
        checksum/redis-config: e82c09fa615350d9c147a0884485f953308babd6b8842d0cbe695ed5595eb530
    spec:
      securityContext:
        runAsUser: 10000
        runAsGroup: 10000
        fsGroup: 10000
      initContainers:
        - name: patch-log-dirs
          image: registry.access.redhat.com/ubi9/ubi
          imagePullPolicy: IfNotPresent
          command: [ 'sh', '-c', '
                mkdir -p /var/values_dir;
                chmod -v g+rwxs /var/values_dir;
                if [ -d "/var/values_dir" ];
                then
                    setfacl -n -Rm d:m::rwx,m::rwx,d:g:10000:rwx,g:10000:rwx /var/values_dir;
                fi;' ]
          securityContext:
            runAsUser: 0
          volumeMounts:
          - name: values-directory
            mountPath: /var/values_dir
      containers:
      - name: ui-backend
        image: "ghcr.io/splunk/sc4snmp-ui/backend/container:main"
        imagePullPolicy: Always
        command: ["sh","-c","/flask_start.sh"]
        env:
        - name: MONGO_URI
          value: mongodb://release-name-mongodb:27017
        
        - name: REDIS_MODE
          value: "standalone"
        - name: REDIS_HOST
          value: release-name-redis
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_DB
          value: "1"
        - name: CELERY_DB
          value: "0"
        - name: JOB_CONFIG_PATH
          value: /config/job_config.yaml
        - name: JOB_NAMESPACE
          value: "default"
        - name: VALUES_DIRECTORY
          value: /var/values_dir
        - name: VALUES_FILE
          value: values.yaml
        - name: KEEP_TEMP_FILES
          value: "false"
        ports:
        - containerPort: 5000
        volumeMounts:
        - name: backend-configmap
          mountPath: /config
        - name: values-directory
          mountPath: /var/values_dir
      serviceAccountName: job-robot
      volumes:
        - name: backend-configmap
          configMap:
            name: splunk-connect-for-snmp-job-configmap
            items:
              - key: job_config
                path: job_config.yaml
        - name: values-directory
          hostPath:
            path: /home/ubuntu
