{{- if and .Values.mongodb.auth.enabled (not .Values.mongodb.auth.existingSecret) }}
{{- $secretName := printf "%s-mongodb" .Release.Name }}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace $secretName }}

{{- /* Determine password */ -}}
{{- $password := "" }}
{{- if $existingSecret }}
  {{- /* Use existing password if secret exists */ -}}
  {{- $password = index $existingSecret.data "password" | b64dec }}
{{- else }}
  {{- /* Generate new password */ -}}
  {{- $password = .Values.mongodb.auth.password | default (randAlphaNum 16) }}
{{- end }}

{{- /* Determine replica key for replicaset mode */ -}}
{{- $replicaKey := "" }}
{{- if eq .Values.mongodb.mode "replicaset" }}
  {{- if $existingSecret }}
    {{- $replicaKey = index $existingSecret.data "replica-key" | b64dec }}
  {{- else }}
    {{- $replicaKey = randAlphaNum 32 }}
  {{- end }}
{{- end }}

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    app: {{ .Release.Name }}-mongodb
  annotations:
    "helm.sh/resource-policy": keep
type: Opaque
data:
  # Primary key
  password: {{ $password | b64enc | quote }}

  # Compatibility aliases (same password)
  mongodb-root-password: {{ $password | b64enc | quote }}
  mongodb-password: {{ $password | b64enc | quote }}

  {{- if eq .Values.mongodb.mode "replicaset" }}
  # Replica set key
  replica-key: {{ $replicaKey | b64enc | quote }}
  {{- end }}
{{- end }}