#Poller Configuration
Poller is a service which is responsible for querying 
SNMP devices using SNMP GET, SNMP WALK functionality. Poller executes two main types of tasks:

- Walk task - executes SNMP walk. SNMP walk is an SNMP application that uses SNMP GETNEXT requests to 
collect SNMP data from the network and infrastructure SNMP-enabled devices, such as switches and routers. It is a time-consuming task,
which may overload the SNMP device when executing too often. It is used by SC4SNMP to collect and push all OIDs values which provided ACL has access to. 
  
- Get task - it is a lightweight task whose goal is to query a subset of OIDs defined by the customer. The task serves for a frequent monitoring OIDs like memory or CPU utilization.  

Poller has an `inventory`, which defines what and how often SC4SNMP has to poll.

### Poller configuration file

Poller configuration is kept in `values.yaml` file in a `poller` section.
`values.yaml` is being used during the installation process for configuring Kubernetes values.

Poller example configuration:
```yaml
poller:
  logLevel: "WARN"
  inventory: |
    address,port,version,community,secret,security_engine,walk_interval,profiles,smart_profiles,delete
    10.202.4.202,,2c,public,,,2000,,,
```

NOTE: header's line (`address,port,version,community,secret,security_engine,walk_interval,profiles,smart_profiles,delete`) is necessary for the correct execution of SC4SNMP. Do not remove it.

### Define log level
Log level for poller can be set by changing the value for key `logLevel`. Allowed values are: `DEBUG`, `INFO`, `WARNING`, `ERROR`. 
The default value is `WARNING`

### Configure inventory 
To update inventory, follow instruction: [Update Inventory and Profile](#update-inventory-and-profile).

`inventory` section in `poller` has following fields to configure:

 - `address` [REQUIRED] - IP address which SC4SNMP should connect to collect data from or name of the group of hosts. General
information about groups can be found on [Configuring Groups](configuring-groups.md) page.
 - `port` [OPTIONAL] - SNMP listening port. Default value `161`.
 - `version` [REQUIRED] - SNMP version, allowed values: `1`, `2c` or `3`
 - `community` [OPTIONAL] - SNMP community string, filed is required when `version` is `1` or `2c`
 - `secret` [OPTIONAL] - usernameSecrets define which secrets in "Secret" objects in k8s should be use, as a value it need to put 
 name of "Secret" objects. Field is required when `version` is `3`. More information how to define "Secrets" object for SNMPv3 can be found 
 in [SNMPv3 Configuration](snmpv3-configuration.md)
 - `security_engine` [OPTIONAL] - security engine ID required by SNMPv3. If not provided for version `3` it is autogenerated.
 - `walk_interval` [OPTIONAL] - interval in seconds for SNMP walk, default value `42000`. This value needs to be between `1800` and `42000`
 - `profiles` [OPTIONAL] - list of SNMP profiles used for the device. More than one profile can be added by semicolon 
separation eg. `profile1;profile2`. More about profiles in [Profile Configuration](../configuring-profiles)
 - `smart_profiles` [OPTIONAL] - enabled smart profiles, by default it's `true`. Allowed value: `true`, `false`.
 - `delete` [OPTIONAL] - flags which define if inventory should be deleted from scheduled tasks for WALKs and GETs. 
Allowed value: `true`, `false`. Default value is `false`.

Example:
```yaml
poller:
    inventory: |
      address,port,version,community,secret,security_engine,walk_interval,profiles,smart_profiles,delete
      10.202.4.202,,2c,public,,,2000,my_profile1,,
      example_group_1,,2c,public,,,2000,my_profile2;my_profile3,,
```


### Update Inventory
Adding new devices for `values.yaml` is quite expensive from the Splunk Connect for SNMP perspective. 
As it interacts with real, networking devices, it requires several checks before applying changes. SC4SNMP was designed to prevent changes in inventory
task more often than every 5 min. 
 
To apply inventory changes in `values.yaml`, following steps need to be executed:

1. Edit `values.yaml` 
2. Check if inventory pod is still running by an execute command
   
```shell
microk8s kubectl -n sc4snmp get pods | grep inventory
```
   
If the command does not return any pods, follow the next step. In another case, wait and execute the command again until the moment 
when inventory job finishes. 

If you really need to apply changes immediately, you can get around the limitation by deleting inventory job, with:

```shell
microk8s kubectl delete job/snmp-splunk-connect-for-snmp-inventory -n sc4snmp
```

After running this command, you can proceed with upgrading without a need to wait.
   
3. Run upgrade command :

```shell
microk8s helm3 upgrade --install snmp -f values.yaml splunk-connect-for-snmp/splunk-connect-for-snmp --namespace=sc4snmp --create-namespace
```

NOTE: If you decide to change frequency of the profile without changing inventory data, the change will be reflected after 
next walk process for the host. Walk happens every `walk_interval` or on any change in inventory.
